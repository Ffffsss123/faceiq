<script>
let uploadedFile = null;

// 模型加载完成后打印
Promise.all([
  faceapi.nets.ssdMobilenetv1.loadFromUri('/static/models'),
  faceapi.nets.faceRecognitionNet.loadFromUri('/static/models'),
]).then(() => {
  console.log('✔ 模型加载完成');
});

// 选择文件时打印
document.getElementById('upload').onchange = e => {
  uploadedFile = e.target.files[0];
  console.log('✔ 已选中文件：', uploadedFile && uploadedFile.name);
  document.getElementById('output').textContent = '已选择：' + (uploadedFile?.name||'');
};

// 点击按钮时打印
document.getElementById('goBtn').onclick = async () => {
  console.log('▶ 点击了“开始预测”按钮');
  if (!uploadedFile) {
    console.warn('⚠️ 还没选择文件');
    alert('请先选择一张图片！');
    return;
  }

  console.log('▶ 开始 face-api 检测');
  const img = await faceapi.bufferToImage(uploadedFile);
  console.log('▶ image object 准备好');
  const dets = await faceapi.detectAllFaces(img)
                       .withFaceLandmarks()
                       .withFaceDescriptors();
  console.log('▶ 检测到人脸数量：', dets.length);
  if (dets.length === 0) {
    document.getElementById('output').textContent = '未检测到人脸，请换张清晰的正面照片。';
    return;
  }

  const descriptors = dets.map(d => Array.from(d.descriptor));
  console.log('▶ descriptors:', descriptors);
  console.log('▶ 发起 POST /predict');
  const res = await fetch('/predict', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({descriptors})
  });
  console.log('▶ POST 完成，等待结果');
  const json = await res.json();
  console.log('▶ 后端返回数据：', json);

  document.getElementById('output').textContent =
    json.map((r,i) =>
      `人脸${i+1}: 对比人类智慧学家的相似度 ${(r.sim*100).toFixed(2)}%, IQ ${r.iq.toFixed(1)} —— ${r.label}`
    ).join('\n');
};
</script>
